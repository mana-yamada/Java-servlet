package addUser;

import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.io.Reader;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Properties;

public class SQLTest {


	//データ受信
	public void inputData() {
		String strUserId = "1";
		int userId = Integer.parseInt(strUserId);
		String password = "12345678910";
		String name = "Nokko Yamada";
		String mail = "123456789012345678901234567890123456789012345678901";
		String tel = "11112222333344445555";

		dataCheck(password, name, mail, tel);
		idCheck(strUserId, userId);
	}
//SQLで判定してから文字列判定
	public void idCheck(String strUserId, int userId) {
		//入力されたuserIdは既に登録されているかSQLのデータチェック
		//userIdのチェック
		String userError = "";
		if(strUserId.length() == 0 || strUserId == null) {
			//ユーザーIDが入力されていないときのエラー文
			userError = "<p>・ユーザーIDが入力されていません</p>";
		}
		driverConnect();
		readDB(userId);
	}

	public void driverConnect() {
		try {
			Class.forName("com.mysql.cj.jdbc.Driver");
		}catch(ClassNotFoundException e) {
			System.out.println("ドライバーが正しくセットされていません");
		}
	}

	//プロパティファイルから接続先のデータを読み込み
	public void readDB(int userId) {
		try {
			Reader fr = new FileReader("C:\\Users\\mana-koba\\Java-servlet\\Java-servlet\\usersystem2\\MySQLdocs.properties");
			Properties p = new Properties();
			p.load(fr);
			final String URL = p.getProperty("url");
			final String USERNAME = p.getProperty("userName");
			final String PASS = p.getProperty("pass");
			fr.close();
			connection(URL, USERNAME, PASS, userId);
		}catch(FileNotFoundException e) {
			e.printStackTrace();
		}catch(IOException e) {
			e.printStackTrace();
		}
	}

	//DB接続及びSQL操作・DB切断
	public void connection(String URL, String USERNAME, String PASS ,  int userId) {
		//DBへの接続
		Connection con = null;
		try {
			con = DriverManager.getConnection(URL, USERNAME, PASS);
			//自動コミットモードの解除
			con.setAutoCommit(false);
			PreparedStatement pstmt = null;
			ResultSet rs = null;
			//SQL操作 //新規登録前の検索
			checkUserId( con ,  pstmt , rs, userId);
		}catch(SQLException e){
			e.printStackTrace();
			//ロールバック
			try {
				con.rollback();
			}catch(SQLException e2) {
				e2.printStackTrace();
			}
		}finally {
			//DB接続を切断
			if(con != null) {
				try {
					con.close();
				}catch(SQLException e3) {
					e3.printStackTrace();
				}
			}
		}
	}
	//ユーザーIDのチェック
	public void checkUserId(Connection con , PreparedStatement pstmt ,ResultSet rs , int userId) throws SQLException{
		//SQL送信処理
		//ひな型
		pstmt = con.prepareStatement("SELECT * FROM users WHERE userId = ?");
		//ひな型に値を流し込み
		pstmt.setInt(1, userId);
		//検索系SQL文を自動組み立て、送信
		rs = pstmt.executeQuery();
		//結果票の処理 //既にユーザーが登録されていたらエラー文を出す
		String SQLUserError = "";
		String SQLUser = "";
		if(rs.next()) {
			SQLUserError = "<p> ・入力したユーザーはユーザー登録されています</p>";
			//System.out.println(SQLUserError);
			//SQLUserErrorはそれで、
			//dataCheck(strUserId , userId , password , name, mail , tel , SQLUserError , SQLUser);
			//String strUserId, int userId,  String password, String name, String mail, String tel , String SQLUserError ,String SQLUser
		}else {
			//System.out.println("入力したユーザーはユーザー登録されていません。新規登録をしてください");
			SQLUser = "<p>ユーザーID：" + userId + "</p>";
			System.out.println(SQLUser);
		}

		//後片付け
		rs.close();
		pstmt.close();
		//送信済みの処理要求の確定（コミット）
		con.commit();
	}

	//データ判定 userId以外
	public void dataCheck(String password, String name, String mail, String tel) {
		//取得したリクエストパラメータをチェック
				//⇒エラー時の出力文づくり・動作が正常時の出力文づくり
				String errorMsg = "";
				String msg = "";
				try {
					//passwordチェック
					if(password.length() == 0 || password == null ) {
						errorMsg = "<p>・パスワードが入力されていません。</p>";
					}else if(password.length() < 8 || password.length() > 20) {
						errorMsg += "<p>" +  "・パスワードが8文字以上20文字以内で正しく入力されていません。" + "</p>";
					}else {
						msg += "<p>パスワード：*************</p>";
					}
					//nameチェック
					if( name.length() == 0 || name == null) {
						errorMsg = "<p>・名前が入力されていません。 </p>";
					}else if(name.length() > 50) {
						errorMsg += "<p>" + "・名前が長すぎです。(50文字以内)" + "</p>";
					}else {
						msg += "<p>名前：" + name + "</p>";
					}
					//mailチェック
					if( mail.length() == 0 || mail  == null) {
						errorMsg = "<p>メールアドレスが入力されていません。</p>";
					}else if(mail.length() > 50) {
						errorMsg += "<p>" + "・メールアドレスが長すぎです。(50文字以内)"  + "</p>";
					}else {
						msg += "<p>メールアドレス：" + mail + "</p>";
					}
					//telチェック
					if( tel.length() == 0 || tel == null) {
						errorMsg = "<p>・電話番号が入力されていません。</p>";
					}else if(tel.length() > 15) {
						errorMsg += "<p>" + "・電話番号が長すぎです。(15文字以内)" + "</p>";
					}else {
						msg += "<p>電話番号：" + tel + "<p>";
					}
				}catch(Exception e) {
					e.printStackTrace();
				}
	}

	//出力！！
	public void outputHTML(String userError, String SQLUserError, String errorMsg, String SQLUser, String msg) {
		if(userError.length() != 0) {
			System.out.println("<h1>！エラーメッセージ！<h1>");
			System.out.println(userError);
		}
		if(SQLUserError.length() != 0) {
			System.out.println("<h1>！エラーメッセージ！<h1>");
			System.out.println(SQLUserError);
		}else if (errorMsg.length() != 0) {
			System.out.println("<h1>！エラーメッセージ！<h1>");
			System.out.println(errorMsg);
		}else {
			System.out.println("<h1>新規登録内容確認</h1>" );
			System.out.println(SQLUser);
			System.out.println(msg);
		}
		//文の出力 別のメソッドにしたほうが良い！！
//		if(errorMsg.length() == 0) {
//			System.out.println("<h1>新規登録内容確認</h1>" );
//			System.out.println(msg);
//		}else {
//			System.out.println("<h1>！エラーメッセージ！<h1>");
//			System.out.println(errorMsg);
//		}

	}

}
